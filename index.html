<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WeaversNest â€” Voice + Chatbase (Netlify)</title>
  <style>
    body { margin:0; font-family:Arial,system-ui; background:#f6f7fb; min-height:100vh; }
    #voiceBtn { position:fixed; right:20px; bottom:90px; width:64px; height:64px; border-radius:50%; border:0; background:#ff3b30; color:#fff; font-size:28px; cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,.16); z-index:9999; }
    #voiceBtn.active{ background:#16a34a; animation:pulse 1.2s infinite; }
    @keyframes pulse {0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
    #replyToast { position:fixed; right:20px; bottom:170px; max-width:420px; background:#fff; border-radius:10px; padding:12px 14px; box-shadow:0 8px 30px rgba(0,0,0,.12); z-index:9998; display:none; font-size:14px; color:#081124; }
    #replyToast .label { font-size:12px; color:#6b7280; margin-bottom:6px; }
  </style>
</head>
<body>

  <!-- Chatbase embed (agent id prefilled) -->
  <script>
  (function(){
    if(!window.chatbase||window.chatbase("getState")!=="initialized"){
      window.chatbase=(...arguments)=>{ if(!window.chatbase.q){window.chatbase.q=[]} window.chatbase.q.push(arguments) };
      window.chatbase=new Proxy(window.chatbase,{ get(target,prop){ if(prop==="q"){return target.q} return(...args)=>target(prop,...args) }});
    }
    const onLoad=function(){
      const script=document.createElement("script");
      script.src="https://www.chatbase.co/embed.min.js";
      script.id="xYe8wmdbOM5iVwIDOCkGk"; // your Agent ID
      script.domain="www.chatbase.co";
      document.body.appendChild(script);
    };
    if(document.readyState==="complete"){ onLoad(); } else { window.addEventListener("load", onLoad); }
  })();
  </script>

  <!-- floating mic -->
  <button id="voiceBtn" title="Speak">ðŸŽ¤</button>

  <!-- small toast for proxy replies -->
  <div id="replyToast" role="status" aria-live="polite">
    <div class="label">Assistant (from proxy):</div>
    <div id="replyText"></div>
  </div>

  <script>
    // ---------------- CONFIG ----------------
    // When hosting on Netlify (both frontend + functions), use the relative path below:
    let SERVER_ENDPOINT = '/.netlify/functions/chat';
    // ----------------------------------------

    const voiceBtn = document.getElementById('voiceBtn');
    const replyToast = document.getElementById('replyToast');
    const replyText = document.getElementById('replyText');

    const synth = window.speechSynthesis;
    let voices = [];
    function populateVoices(){ voices = synth.getVoices(); }
    if (speechSynthesis) { populateVoices(); if (typeof speechSynthesis.onvoiceschanged !== 'undefined') speechSynthesis.onvoiceschanged = populateVoices; }

    function speak(text){
      try {
        if (!text || !('speechSynthesis' in window)) return;
        synth.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-IN';
        if (voices && voices.length) u.voice = voices.find(v=>v.lang && v.lang.toLowerCase().includes('en')) || voices[0];
        synth.speak(u);
      } catch (e) { console.warn('TTS failed', e); }
    }

    function showReplyToast(text){
      replyText.textContent = text;
      replyToast.style.display = 'block';
      clearTimeout(showReplyToast._t);
      showReplyToast._t = setTimeout(()=> replyToast.style.display = 'none', 7000);
    }

    async function sendToProxy(message){
      try {
        const r = await fetch(SERVER_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ message })
        });
        if (!r.ok) {
          const t = await r.text();
          console.error('Proxy error', r.status, t);
          return { error:true, text: 'Proxy error ' + r.status };
        }
        const j = await r.json();
        return { error:false, text: j.reply || j.result || j.message || '' };
      } catch (err) {
        console.error('Network/proxy error', err);
        return { error:true, text: 'Network error' };
      }
    }

    // Speech recognition flow
    let recognition, recognizing=false;
    function initRecognition(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      const r = new SR();
      r.lang = 'en-IN';
      r.interimResults = false;
      r.maxAlternatives = 1;
      r.onstart = ()=>{ recognizing = true; voiceBtn.classList.add('active'); };
      r.onend   = ()=>{ recognizing = false; voiceBtn.classList.remove('active'); };
      r.onresult = async (ev) => {
        const text = ev.results[0][0].transcript.trim();
        console.log('Heard:', text);
        // Open the widget UI if available
        try { window.chatbase && window.chatbase.open && window.chatbase.open(); } catch(e){ /* ignore */ }
        // Send to your Netlify function (proxy)
        const res = await sendToProxy(text);
        if (res.error) {
          showReplyToast('[Error] ' + res.text);
          speak('[Error] ' + res.text);
        } else {
          const reply = res.text || '(no response)';
          showReplyToast(reply);
          speak(reply);
        }
      };
      r.onerror = (e)=>{ console.error('Recognition error', e); alert('Speech recognition error: '+(e.error||e.message||e)); };
      return r;
    }

    voiceBtn.addEventListener('click', ()=>{
      if (!recognition) recognition = initRecognition();
      if (!recognition) { alert('Speech Recognition not available in this browser. Use Chrome/Edge.'); return; }
      if (recognizing) recognition.stop(); else recognition.start();
    });

    // If chatbase widget emits assistant messages, speak them too (best-effort)
    window.addEventListener('load', ()=>{
      try {
        if (window.chatbase && typeof window.chatbase.addEventListener === 'function') {
          window.chatbase.addEventListener('assistant-message', (ev)=> {
            const content = ev?.data?.content;
            if (content) { speak(content); showReplyToast(content); }
          });
        }
      } catch(e){ console.warn('chatbase event hook failed', e); }
    });

    console.info('Voice->proxy ready. SERVER_ENDPOINT =', SERVER_ENDPOINT);
  </script>
</body>
</html>
